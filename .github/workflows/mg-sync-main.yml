name: 同步mg主库

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

# 授予必要权限（GITHUB_TOKEN 自动获得 contents + workflows 权限）
permissions:
  contents: write

jobs:
  sync-nodes:
    runs-on: ubuntu-latest
    steps:

      # 检出主仓库（使用默认 GITHUB_TOKEN，不指定 token）
      - name: Checkout Your Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史以便 merge

      # 配置 Git 使用 GITHUB_TOKEN 进行推送（关键！）
      - name: Configure Git credentials for push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # 将 origin URL 改为带 GITHUB_TOKEN 的 HTTPS 格式
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
      # 设置 Python 环境
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 执行同步脚本
      - name: Run sync script
        run: |
          # 设置环境变量跳过 LFS 下载
          export GIT_LFS_SKIP_SMUDGE=1
                    
          git remote add upstream https://github.com/mg-org-1/ComfyUI.git 2>/dev/null || true
          git fetch upstream
          git checkout master
          
          # === 备份本地关键文件 ===
          LOCAL_README_EXIST=0
          if [ -f "README.md" ]; then
            cp README.md /tmp/README.md.backup
            LOCAL_README_EXIST=1
          fi
          
          LOCAL_WORKFLOWS_EXIST=0
          if [ -d ".github/workflows" ]; then
            cp -r .github/workflows /tmp/workflows.backup
            LOCAL_WORKFLOWS_EXIST=1
          fi
          
          # === 合并上游 ===
          # --no-ff 确保总是创建一个合并提交，--no-commit 阻止自动提交
          if ! git merge --no-ff --no-commit upstream/master; then
            echo "Merge conflict detected. Resolving by taking upstream version..."
            # 如果有冲突, 用 'theirs' (上游) 版本解决 *所有* 冲突
            git checkout --theirs .
            git add .
            # 注意：这里我们也不 commit
          fi
          
          # 此时，所有上游更改都在暂存区 (staged)，但未提交
          
          # === 恢复本地文件 ===
          # 现在恢复你的本地文件，这将覆盖暂存区中的上游版本
          if [ "$LOCAL_README_EXIST" = "1" ]; then
            cp /tmp/README.md.backup README.md
            git add README.md
            echo "Restored local README.md"
          else
            # 如果本地没有，就删除上游的
            rm -f README.md
            git add README.md 2>/dev/null || true
            echo "Removed upstream README.md (not present locally)"
          fi
          
          if [ "$LOCAL_WORKFLOWS_EXIST" = "1" ]; then
            rm -rf .github/workflows
            cp -r /tmp/workflows.backup .github/workflows
            git add .github/workflows
            echo "Restored local .github/workflows"
          else
            # 如果本地没有，就删除上游的
            rm -rf .github/workflows 2>/dev/null || true
            git add .github 2>/dev/null || true
            echo "Removed upstream .github/workflows (not present locally)"
          fi
          
          # 清理空的 .github 目录
          if [ -d ".github" ] && [ -z "$(ls -A .github)" ]; then
            rmdir .github
            git add -A
          fi

          # === 统一提交 ===
          # 检查暂存区是否有任何更改。
          # 如果上游没有新内容，且本地文件也无变化，则暂存区是空的
          if ! git diff --cached --quiet; then
            echo "Committing merged changes and local file restorations..."
            git commit -m "Sync with upstream/master and restore local files (README.md, .github/workflows)"
          else
            echo "No new changes from upstream to commit."
          fi
          
          # === 推送 ===
          echo "Pushing changes to origin master..."
          git push origin master
